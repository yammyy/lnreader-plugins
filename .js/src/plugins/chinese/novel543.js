var t=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(i,a){function o(t){try{c(n.next(t))}catch(t){a(t)}}function s(t){try{c(n.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,s)}c((n=n.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,n,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(c){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.makeChunksFromHTML=c,exports.translate=u,exports.translateAutoHotkeyStyle=p;var r=require("cheerio"),n=require("@libs/fetch"),i=require("@libs/defaultCover"),a=require("@libs/novelStatus"),o=function(){function o(){this.id="novel543",this.name="Novel543",this.site="https://www.novel543.com/",this.version="16.0.2",this.icon="src/cn/novel543/icon.png",this.imageRequestInit={headers:{Referer:this.site}}}return o.prototype.popularNovels=function(a){return t(this,void 0,void 0,(function(){var t,o,c,l,u,h=this;return e(this,(function(e){switch(e.label){case 0:return a>1?[2,[]]:[4,(0,n.fetchApi)(this.site)];case 1:return(t=e.sent()).ok?(c=r.load,[4,t.text()]):[2,[]];case 2:return o=c.apply(void 0,[e.sent()]),l=[],u=new Set,o('ul.list > li.media, ul.list li > a[href^="/"][href$="/"]').each((function(t,e){var r,n,a,c,p,f,d,v,m=o(e);if(m.is("li.media")){var g=m.find(".media-content h3 a");f=null===(r=g.attr("href"))||void 0===r?void 0:r.trim(),d=g.text().trim(),v=null===(n=m.find(".media-left img").attr("src"))||void 0===n?void 0:n.trim()}else m.is("a")&&(f=null===(a=m.attr("href"))||void 0===a?void 0:a.trim(),d=m.find("h3, b, span").first().text().trim()||m.parent().find("h3").text().trim()||m.text().trim(),v=(null===(c=m.find("img").attr("src"))||void 0===c?void 0:c.trim())||(null===(p=m.parent().find("img").attr("src"))||void 0===p?void 0:p.trim()));f&&d&&f.match(/^\/\d+\/$/)&&!u.has(f)&&(l.push({name:d,path:f,cover:s(v,h.site)||i.defaultCover}),u.add(f))})),[2,l]}}))}))},o.prototype.parseNovel=function(o){return t(this,void 0,void 0,(function(){var t,c,l,h,p,f,d,v,m,g,b,w;return e(this,(function(e){switch(e.label){case 0:if(!(t=s(o,this.site)))throw new Error("Invalid novel URL");return[4,(0,n.fetchApi)(t)];case 1:if(!(c=e.sent()).ok)throw new Error("Failed to fetch novel");return h=r.load,[4,c.text()];case 2:return l=h.apply(void 0,[e.sent()]),p=l("section#detail div.media div.media-content"),f=l("section#detail div.mod"),d=l("div.intro.is-hidden-mobile"),[4,u(d.text().trim(),"ru")];case 3:switch(v=e.sent(),m=p.find('p.meta a[href*="/bookstack/"]').text().trim()){case"ç„å¹»":m="Fantasy";break;case"ä¿®çœŸ":m="Cultivation";break;case"éƒ½å¸‚":m="Urban";break;case"æ­·å²":m="Historical";break;case"ç¶²éŠ":m="Games";break;case"ç§‘å¹»":m="Sci-fi";break;case"å¥³é »":m="Female";break;case"éˆç•°":m="Supernatural";break;case"åŒäºº":m="Fan Fiction";break;case"è»äº‹":m="Military";break;case"æ‡¸ç–‘":m="Suspense";break;case"ç©¿è¶Š":m="Time Travel";break;case"å…¶å®ƒ":case"å…¶ä»–":m="Other"}return g={path:o,name:p.find("h1.title").text().trim()||"Untitled",cover:s(l("section#detail div.cover img").attr("src"),this.site)||i.defaultCover,summary:v||void 0,author:p.find("p.meta span.author").text().trim()||void 0,genres:m||void 0,status:a.NovelStatus.Unknown,chapters:[]},(b=f.find('p.action.buttons a.button.is-info[href$="/dir"]').attr("href")||p.find('a.button.is-info[href$="/dir"]').attr("href"))?(w=g,[4,this.parseChapterList(b)]):[3,5];case 4:w.chapters=e.sent(),e.label=5;case 5:return[2,g]}}))}))},o.prototype.parseChapterList=function(i){return t(this,void 0,void 0,(function(){var t,a,o,c,l;return e(this,(function(e){switch(e.label){case 0:return(t=s(i,this.site))?[4,(0,n.fetchApi)(t)]:[2,[]];case 1:return(a=e.sent()).ok?(c=r.load,[4,a.text()]):[2,[]];case 2:return o=c.apply(void 0,[e.sent()]),l=[],o("div.chaplist ul.all li a").each((function(t,e){var r,n=o(e),i=n.text().trim(),a=null===(r=n.attr("href"))||void 0===r?void 0:r.trim();i&&a&&l.push({name:i,path:a,chapterNumber:t+1})})),"å€’åº"===o("div.chaplist .header button.reverse span").last().text().trim()&&(l.reverse(),l.forEach((function(t,e){return t.chapterNumber=e+1}))),[2,l]}}))}))},o.prototype.parseChapter=function(i){return t(this,void 0,void 0,(function(){var t,a,o,c,l,u,p,f,d,v,m;return e(this,(function(g){switch(g.label){case 0:if(!(t=s(i,this.site)))throw new Error("Invalid chapter URL");a=new URL(t).pathname.replace(/\.html$/i,""),o=t,c=[],l="",u=0,p=50,f=function(){var t,i,p,f,v,g,b,w,y,x;return e(this,(function(e){switch(e.label){case 0:return u++,console.log("Current chapter part URL:",o),[4,(0,n.fetchApi)(o)];case 1:if(!(t=e.sent()).ok)throw new Error("Failed to fetch: ".concat(o));return[4,t.text()];case 2:return i=e.sent(),p=(0,r.load)(i),l||(f=p("h1").first(),l=f.text().trim()),(v=p("div.content.py-5")).length?(v.find('script, style, ins, iframe, [class*="ads"], [id*="ads"], [class*="google"], [id*="google"], [class*="recommend"], div[align="center"], p:contains("æ¨è–¦æœ¬æ›¸"), a[href*="javascript:"]').remove(),v.find("p").each((function(t,e){var r,n=p(e),i=n.text().trim();(i.includes("è«‹è¨˜ä½æœ¬ç«™åŸŸå")||i.includes("æ‰‹æ©Ÿç‰ˆé–±è®€ç¶²å€")||i.includes("novel543")||i.includes("ç¨·ä¸‹æ›¸é™¢")||i.includes("æœ€å¿«æ›´æ–°")||i.includes("æœ€æ–°ç« ç¯€")||i.includes("ç« ç¯€å ±éŒ¯")||i.match(/app|APP|ä¸‹è¼‰|å®¢æˆ·ç«¯|å…³æ³¨å¾®ä¿¡|å…¬ä¼—å·/i)||0===i.length||""===(null===(r=n.html())||void 0===r?void 0:r.replace(/&nbsp;/g,"").trim())&&0===n.find("img").length||i.includes("æº«é¦¨æç¤º"))&&n.remove()})),v.contents().filter((function(){return"comment"===this.type})).remove(),g=(null===(m=v.html())||void 0===m?void 0:m.trim())||"",console.log("=== Content ==="),console.log(g.slice(0,200)),[4,h(g,"ru","zh-TW")]):(console.warn("No content found in",o),[2,"break"]);case 3:return b=e.sent(),console.log("=== Translate ==="),console.log(b.slice(0,200)),b&&c.push(b),(w=p('a:contains("ä¸‹ä¸€ç« ")').attr("href"))?w.startsWith("#")||/^javascript:/i.test(w)?[2,"break"]:(y=s(w,d.site)||"",console.log("Next part URL:",y),y===o?[2,"break"]:(x=new URL(y).pathname.replace(/(?:_\d+)?\.html$/i,""),console.log("Next base path:",x),console.log("Base path:",a),x!==a?[2,"break"]:(o=y,[2]))):[2,"break"]}}))},d=this,g.label=1;case 1:return o&&u<p?[5,f()]:[3,3];case 2:return"break"===g.sent()?[3,3]:[3,1];case 3:return u>=p&&console.warn("parseChapter: reached MAX_PAGES while loading chapter parts"),(v=c.join("<br>")).trim()?[2,"<h1>"+l+"</h1> ğŸ¼<br>"+v.trim()]:[2,"Error: Chapter content was empty"]}}))}))},o.prototype.searchNovels=function(a,o){return t(this,void 0,void 0,(function(){var t,c,l,u,h,p,f,d,v,m,g=this;return e(this,(function(e){switch(e.label){case 0:if(o>1)return[2,[]];if(!/^\d+$/.test(a))return[3,4];e.label=1;case 1:return e.trys.push([1,3,,4]),t="/".concat(a,"/"),[4,this.parseNovel(t)];case 2:return[2,[{name:(c=e.sent()).name,path:t,cover:c.cover}]];case 3:return e.sent(),[2,[]];case 4:l="".concat(this.site,"search/").concat(encodeURIComponent(a)),u="",e.label=5;case 5:return e.trys.push([5,8,,9]),[4,(0,n.fetchApi)(l)];case 6:if(!(h=e.sent()).ok){if(403===h.status||503===h.status)throw new Error("Cloudflare protection detected (HTTP error). Please try opening the plugin in WebView first to solve the challenge.");return[2,[]]}return[4,h.text()];case 7:if(u=e.sent(),p=(0,r.load)(u),(f=p("title").text().toLowerCase()).includes("attention required")||f.includes("just a moment")||f.includes("please wait")||f.includes("verifying")||u.includes("Verifying you are human")||u.includes("cf-browser-verification")||u.includes("cf_captcha_container"))throw new Error("Cloudflare protection detected. Please try opening the plugin in WebView first to solve the challenge.");return[3,9];case 8:if((d=e.sent())instanceof Error){if(d.message.includes("Cloudflare protection detected"))throw d;throw new Error("Failed to fetch search results: ".concat(d.message))}throw d;case 9:return v=(0,r.load)(u),m=[],v("div.search-list ul.list > li.media").each((function(t,e){var r,n,a=v(e),o=a.find(".media-content h3 a"),c=null===(r=o.attr("href"))||void 0===r?void 0:r.trim(),l=o.text().trim(),u=null===(n=a.find(".media-left img").attr("src"))||void 0===n?void 0:n.trim();c&&l&&c.match(/^\/\d+\/$/)&&m.push({name:l,path:c,cover:s(u,g.site)||i.defaultCover})})),[2,m]}}))}))},o}();exports.default=new o;var s=function(t,e){if(t)try{if(t.startsWith("//"))return new URL(e).protocol+t;if(t.startsWith("http://")||t.startsWith("https://"))return t;var r=e.endsWith("/")?e.slice(0,-1):e,n=t.startsWith("/")?t.slice(1):t;return new URL(n,r).href}catch(t){return}};function c(t,e){return void 0===e&&(e=1e3),function(t){return t.replace(/<\/p\s*>/gi,"\n").replace(/<p[^>]*>/gi,"\n").replace(/<br\s*\/?>/gi,"\n").replace(/<[^>]+>/g,"").replace(/\u3000/g," ").replace(/&nbsp;/g," ").trim().split(/\n+/).map((function(t){return t.trim()})).filter(Boolean)}(t).flatMap((function(t){return function(t,e){return void 0===e&&(e=1e3),t.length<=e?[t]:t.split(/([ã€‚.!?ï¼ï¼Ÿ])/g).reduce((function(t,r){return!t.length||(t[t.length-1]+r).length>e?t.push(r):t[t.length-1]+=r,t}),[]).flatMap((function(t){if(t.length<=e)return[t];for(var r=[],n="",i=0,a=t.split(/\s+/);i<a.length;i++){var o=a[i];(n+" "+o).trim().length>e?(n&&r.push(n.trim()),n=o):n=(n+" "+o).trim()}return n&&r.push(n.trim()),r}))}(t,e)}))}function l(r,n){return t(this,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return[4,fetch("https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-CN&tl=".concat(n,"&dt=t&q=").concat(encodeURIComponent(r)))];case 1:if(!(t=e.sent()).ok)throw new Error("Translate failed ".concat(t.status," ").concat(r));return[4,t.json()];case 2:return[2,e.sent()[0].map((function(t){return t[0]})).join("")]}}))}))}function u(r,n){return t(this,void 0,void 0,(function(){var t,i,a,o,s,u,h;return e(this,(function(e){switch(e.label){case 0:if(r.length<2)return[2,r];t=c(r,1e3),i=[],a=0,o=t,e.label=1;case 1:return a<o.length?(s=o[a],h=(u=i).push,[4,l(s,n)]):[3,5];case 2:return h.apply(u,[e.sent()]),[4,new Promise((function(t){return setTimeout(t,500)}))];case 3:e.sent(),e.label=4;case 4:return a++,[3,1];case 5:return[2,i.map((function(t){return"<p>".concat(t,"</p>")})).join("\n")]}}))}))}function h(r,n){return t(this,arguments,void 0,(function(t,r,n){var i,a,o,s,c,l,u,h,f,d,v,m,g,b;return void 0===n&&(n="auto"),e(this,(function(e){switch(e.label){case 0:for(t=t.replace(/<(\w+)[^>]*>/g,"<$1>"),i=["</p>","</h1>","</h2>","</h3>","</h4>","</li>","<br>"],a=[],o=new RegExp("(".concat(i.join("|"),")"),"gi"),s=t.split(o).filter(Boolean),m=0;m<s.length;m++)c=s[m],i.includes(c.toLowerCase())||(l=s[m+1]&&i.includes(s[m+1].toLowerCase())?s[m+1].toLowerCase():"",(u=c.replace(/<[^>]+>/g,"").trim())&&("</li>"===l?a.push({tag:"LI",text:u,parentTag:"UL"}):l.startsWith("</h")?(a.push({tag:l.replace(/[<>]/g,"").toUpperCase(),text:u}),a.push({tag:"BR",text:""})):a.push({tag:"P",text:u})));return h=" ğŸ˜€ ",[4,p(a.map((function(t){return"BR"===t.tag?"":t.text})).join(h),r,n)];case 1:for(f=(f=e.sent()).replace(/^\[\[\"/,"").replace(/\"\],\s*\[\".*\"\]\]$/,""),d=f.split(h),v="",m=0;m<a.length;m++)g=a[m],b=d[m]||"",/^Ğ“Ğ»Ğ°Ğ²Ğ°\s+\d+/i.test(b)?v+="<h1>".concat(b,"</h1>"):"BR"===g.tag?v+="<br>":"LI"===g.tag?v+="<ul><li>".concat(b,"</li></ul>"):g.tag.startsWith("H")?v+="<".concat(g.tag,">").concat(b,"</").concat(g.tag,">"):v+="<p>".concat(b,"</p>");return[2,v]}}))}))}function p(r,n){return t(this,arguments,void 0,(function(t,r,n){var i,a,o,s,c,l;return void 0===n&&(n="auto"),e(this,(function(e){switch(e.label){case 0:i="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36",a=JSON.stringify([[[t],n,r],"te_lib"]),o="",e.label=1;case 1:return e.trys.push([1,6,,7]),[4,fetch("https://translate-pa.googleapis.com/v1/translateHtml",{method:"POST",headers:{"User-Agent":i,"X-Goog-API-Key":"AIzaSyATBXajvzQLTDHEQbcpq0Ihe0vWDHmO520","Content-Type":"application/json+protobuf"},body:a})];case 2:return(s=e.sent()).ok?[3,4]:(o="HTTP error ".concat(s.status,": ").concat(s.statusText),[4,s.text()]);case 3:return c=e.sent(),[2,o+="\nError body:"+c];case 4:return[4,s.text()];case 5:return o=e.sent(),[3,7];case 6:return l=e.sent(),o="Fetch failed:"+l,[3,7];case 7:return[2,o]}}))}))}