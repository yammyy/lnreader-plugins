var e=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}c((n=n.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var r,n,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(c){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.makeChunksFromHTML=s,exports.translate=l;var r=require("cheerio"),n=require("@libs/fetch"),i=require("@libs/defaultCover"),a=require("@libs/novelStatus");function o(e,t){if(void 0===t&&(t=1e3),e.length<=t)return[e];var r=e.split(/([。.!?！？])/g).reduce((function(e,r){return 0===e.length?[r]:((e[e.length-1]+r).length>t?e.push(r):e[e.length-1]+=r,e)}),[]);return r=r.flatMap((function(e){if(e.length<=t)return[e];for(var r=[],n="",i=0,a=e.split(/\s+/);i<a.length;i++){var o=a[i];(n+" "+o).trim().length>t?(n&&r.push(n.trim()),n=o):n=(n+" "+o).trim()}return n&&r.push(n.trim()),r}))}function s(e,t){void 0===t&&(t=1e3);for(var r=function(e){return e.replace(/<\/p\s*>/gi,"\n").replace(/<p[^>]*>/gi,"\n").replace(/<br\s*\/?>/gi,"\n").replace(/<[^>]+>/g,"").replace(/\u3000/g," ").replace(/&nbsp;/g," ").trim().split(/\n+/).map((function(e){return e.trim()})).filter((function(e){return e.length>0}))}(e),n=[],i=0,a=r;i<a.length;i++){var s=o(a[i],t);n.push.apply(n,s)}return n}function c(r,n){return e(this,void 0,void 0,(function(){var e,i;return t(this,(function(t){switch(t.label){case 0:return e="https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-CN&tl=".concat(n,"&dt=t&q=").concat(encodeURIComponent(r)),[4,fetch(e)];case 1:if(!(i=t.sent()).ok)throw new Error("Translate request failed with status ".concat(i.status," ").concat(r));return[4,i.json()];case 2:return[2,t.sent()[0].map((function(e){return e[0]})).join("")]}}))}))}function l(r,n){return e(this,void 0,void 0,(function(){var e,i,a,o,l;return t(this,(function(t){switch(t.label){case 0:if(r.length<2)return[2,r];e=s(r,1e3),i=[],a=0,o=e,t.label=1;case 1:return a<o.length?[4,c(o[a],n)]:[3,5];case 2:return l=t.sent(),i.push(l),[4,new Promise((function(e){return setTimeout(e,500)}))];case 3:t.sent(),t.label=4;case 4:return a++,[3,1];case 5:return[2,i.map((function(e){return"<p>".concat(e,"</p>")})).join("\n")]}}))}))}var u=function(e,t){if(e)try{return e.startsWith("//")?new URL(t).protocol+e:e.startsWith("http://")||e.startsWith("https://")?e:new URL(e,t).href}catch(e){return}},h=function(){function o(){this.id="novel543",this.name="Novel543",this.site="https://www.novel543.com/",this.version="4.0.0",this.icon="src/cn/novel543/icon.png",this.imageRequestInit={headers:{Referer:this.site}}}return o.prototype.popularNovels=function(a){return e(this,void 0,void 0,(function(){var e,o,s,c,l,h=this;return t(this,(function(t){switch(t.label){case 0:return a>1?[2,[]]:[4,(0,n.fetchApi)(this.site)];case 1:return(e=t.sent()).ok?(s=r.load,[4,e.text()]):[2,[]];case 2:return o=s.apply(void 0,[t.sent()]),c=[],l=new Set,o('ul.list > li.media, ul.list li > a[href^="/"][href$="/"]').each((function(e,t){var r,n,a,s,d,f,p,v,m=o(t);if(m.is("li.media")){var b=m.find(".media-content h3 a");f=null===(r=b.attr("href"))||void 0===r?void 0:r.trim(),p=b.text().trim(),v=null===(n=m.find(".media-left img").attr("src"))||void 0===n?void 0:n.trim()}else m.is("a")&&(f=null===(a=m.attr("href"))||void 0===a?void 0:a.trim(),p=m.find("h3, b, span").first().text().trim()||m.parent().find("h3").text().trim()||m.text().trim(),v=(null===(s=m.find("img").attr("src"))||void 0===s?void 0:s.trim())||(null===(d=m.parent().find("img").attr("src"))||void 0===d?void 0:d.trim()));f&&p&&f.match(/^\/\d+\/$/)&&!l.has(f)&&(c.push({name:p,path:f,cover:u(v,h.site)||i.defaultCover}),l.add(f))})),[2,c]}}))}))},o.prototype.parseNovel=function(o){return e(this,void 0,void 0,(function(){var e,s,c,h,d,f,p,v,m,b,g,w;return t(this,(function(t){switch(t.label){case 0:if(!(e=u(o,this.site)))throw new Error("Invalid novel URL");return[4,(0,n.fetchApi)(e)];case 1:if(!(s=t.sent()).ok)throw new Error("Failed to fetch novel");return h=r.load,[4,s.text()];case 2:return c=h.apply(void 0,[t.sent()]),d=c("section#detail div.media div.media-content"),f=c("section#detail div.mod"),p=c("div.intro.is-hidden-mobile"),[4,l(p.text().trim(),"ru")];case 3:switch(v=t.sent(),m=d.find('p.meta a[href*="/bookstack/"]').text().trim()){case"玄幻":m="Fantasy";break;case"修真":m="Cultivation";break;case"都市":m="Urban";break;case"歷史":m="History";break;case"網遊":m="Games";break;case"科幻":m="Science Fiction";break;case"女頻":m="Female";break;case"靈異":m="Supernatural";break;case"同人":m="Fan Fiction";break;case"軍事":m="Military";break;case"懸疑":m="Suspense";break;case"穿越":m="Time Travel";break;case"其它":case"其他":m="Other"}return b={path:o,name:d.find("h1.title").text().trim()||"Untitled",cover:u(c("section#detail div.cover img").attr("src"),this.site)||i.defaultCover,summary:v||void 0,author:d.find("p.meta span.author").text().trim()||void 0,genres:m||void 0,status:a.NovelStatus.Unknown,chapters:[]},(g=f.find('p.action.buttons a.button.is-info[href$="/dir"]').attr("href")||d.find('a.button.is-info[href$="/dir"]').attr("href"))?(w=b,[4,this.parseChapterList(g)]):[3,5];case 4:w.chapters=t.sent(),t.label=5;case 5:return[2,b]}}))}))},o.prototype.parseChapterList=function(i){return e(this,void 0,void 0,(function(){var e,a,o,s,c;return t(this,(function(t){switch(t.label){case 0:return(e=u(i,this.site))?[4,(0,n.fetchApi)(e)]:[2,[]];case 1:return(a=t.sent()).ok?(s=r.load,[4,a.text()]):[2,[]];case 2:return o=s.apply(void 0,[t.sent()]),c=[],o("div.chaplist ul.all li a").each((function(e,t){var r,n=o(t),i=n.text().trim(),a=null===(r=n.attr("href"))||void 0===r?void 0:r.trim();if(i&&a){c.push({name:i,path:a,chapterNumber:e+1});var s=a.replace(/\.html$/,"_2.html");c.push({name:i+" (part 2)",path:s,chapterNumber:e+1.5})}})),"倒序"===o("div.chaplist .header button.reverse span").last().text().trim()&&(c.reverse(),c.forEach((function(e,t){return e.chapterNumber=t+1}))),[2,c]}}))}))},o.prototype.parseChapter=function(i){return e(this,void 0,void 0,(function(){var e,a,o,s,c,h;return t(this,(function(t){switch(t.label){case 0:if(!(e=u(i,this.site)))throw new Error("Invalid chapter URL");return[4,(0,n.fetchApi)(e)];case 1:if(!(a=t.sent()).ok)throw new Error("Failed to fetch chapter");return s=r.load,[4,a.text()];case 2:return o=s.apply(void 0,[t.sent()]),(c=o("div.content.py-5")).length?(c.find('script, style, ins, iframe, [class*="ads"], [id*="ads"], [class*="google"], [id*="google"], [class*="recommend"], div[align="center"], p:contains("推薦本書"), a[href*="javascript:"]').remove(),c.find("p").each((function(e,t){var r,n=o(t),i=n.text().trim();(i.includes("請記住本站域名")||i.includes("手機版閱讀網址")||i.includes("novel543")||i.includes("稷下書院")||i.includes("最快更新")||i.includes("最新章節")||i.includes("章節報錯")||i.match(/app|APP|下載|客户端|关注微信|公众号/i)||0===i.length||""===(null===(r=n.html())||void 0===r?void 0:r.replace(/&nbsp;/g,"").trim())&&0===n.find("img").length||i.includes("溫馨提示"))&&n.remove()})),c.contents().filter((function(){return"comment"===this.type})).remove(),(h=c.html())?(h=h.replace(/<\s*p[^>]*>/gi,"\n\n").replace(/<\s*br[^>]*>/gi,"\n"),[4,l(h=(h=(0,r.load)("<div>".concat(h,"</div>")).text()).replace(/[\t ]+/g," ").replace(/\n{3,}/g,"\n\n").trim(),"ru")]):[2,"Error: Chapter content was empty"]):[2,"Error: Could not find chapter content"];case 3:return[2,h=t.sent()]}}))}))},o.prototype.searchNovels=function(a,o){return e(this,void 0,void 0,(function(){var e,s,c,l,h,d,f,p,v,m,b=this;return t(this,(function(t){switch(t.label){case 0:if(o>1)return[2,[]];if(!/^\d+$/.test(a))return[3,4];t.label=1;case 1:return t.trys.push([1,3,,4]),e="/".concat(a,"/"),[4,this.parseNovel(e)];case 2:return[2,[{name:(s=t.sent()).name,path:e,cover:s.cover}]];case 3:return t.sent(),[2,[]];case 4:c="".concat(this.site,"search/").concat(encodeURIComponent(a)),l="",t.label=5;case 5:return t.trys.push([5,8,,9]),[4,(0,n.fetchApi)(c)];case 6:if(!(h=t.sent()).ok){if(403===h.status||503===h.status)throw new Error("Cloudflare protection detected (HTTP error). Please try opening the plugin in WebView first to solve the challenge.");return[2,[]]}return[4,h.text()];case 7:if(l=t.sent(),d=(0,r.load)(l),(f=d("title").text().toLowerCase()).includes("attention required")||f.includes("just a moment")||f.includes("please wait")||f.includes("verifying")||l.includes("Verifying you are human")||l.includes("cf-browser-verification")||l.includes("cf_captcha_container"))throw new Error("Cloudflare protection detected. Please try opening the plugin in WebView first to solve the challenge.");return[3,9];case 8:if((p=t.sent())instanceof Error){if(p.message.includes("Cloudflare protection detected"))throw p;throw new Error("Failed to fetch search results: ".concat(p.message))}throw p;case 9:return v=(0,r.load)(l),m=[],v("div.search-list ul.list > li.media").each((function(e,t){var r,n,a=v(t),o=a.find(".media-content h3 a"),s=null===(r=o.attr("href"))||void 0===r?void 0:r.trim(),c=o.text().trim(),l=null===(n=a.find(".media-left img").attr("src"))||void 0===n?void 0:n.trim();s&&c&&s.match(/^\/\d+\/$/)&&m.push({name:c,path:s,cover:u(l,b.site)||i.defaultCover})})),[2,m]}}))}))},o}();exports.default=new h;