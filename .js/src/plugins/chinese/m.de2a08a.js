var t=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(i,a){function o(t){try{c(n.next(t))}catch(t){a(t)}}function s(t){try{c(n.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,s)}c((n=n.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,n,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(c){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.makeChunksFromHTML=s,exports.translate=l;var r=require("cheerio"),n=require("@libs/fetch"),i=require("@libs/novelStatus"),a=require("@libs/defaultCover");function o(t,e){if(void 0===e&&(e=1e3),t.length<=e)return[t];var r=t.split(/([。.!?！？])/g).reduce((function(t,r){return 0===t.length?[r]:((t[t.length-1]+r).length>e?t.push(r):t[t.length-1]+=r,t)}),[]);return r=r.flatMap((function(t){if(t.length<=e)return[t];for(var r=[],n="",i=0,a=t.split(/\s+/);i<a.length;i++){var o=a[i];(n+" "+o).trim().length>e?(n&&r.push(n.trim()),n=o):n=(n+" "+o).trim()}return n&&r.push(n.trim()),r}))}function s(t,e){void 0===e&&(e=1e3);for(var r=function(t){return t.replace(/<\/p\s*>/gi,"\n").replace(/<p[^>]*>/gi,"\n").replace(/<br\s*\/?>/gi,"\n").replace(/<[^>]+>/g,"").replace(/\u3000/g," ").replace(/&nbsp;/g," ").trim().split(/\n+/).map((function(t){return t.trim()})).filter((function(t){return t.length>0}))}(t),n=[],i=0,a=r;i<a.length;i++){var s=o(a[i],e);n.push.apply(n,s)}return n}function c(r,n){return t(this,void 0,void 0,(function(){var t,i;return e(this,(function(e){switch(e.label){case 0:return t="https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-CN&tl=".concat(n,"&dt=t&q=").concat(encodeURIComponent(r)),[4,fetch(t)];case 1:if(!(i=e.sent()).ok)throw new Error("Translate request failed with status ".concat(i.status," ").concat(r));return[4,i.json()];case 2:return[2,e.sent()[0].map((function(t){return t[0]})).join("")]}}))}))}function l(r,n){return t(this,void 0,void 0,(function(){var t,i,a,o,l;return e(this,(function(e){switch(e.label){case 0:if(r.length<2)return[2,r];t=s(r,1e3),i=[],a=0,o=t,e.label=1;case 1:return a<o.length?[4,c(o[a],n)]:[3,5];case 2:return l=e.sent(),i.push(l),[4,new Promise((function(t){return setTimeout(t,500)}))];case 3:e.sent(),e.label=4;case 4:return a++,[3,1];case 5:return[2,i.map((function(t){return"<p>".concat(t,"</p>")})).join("\n")]}}))}))}var u=function(t,e){if(t)try{return t.startsWith("//")?new URL(e).protocol+t:t.startsWith("http://")||t.startsWith("https://")?t:new URL(t,e).href}catch(t){return}},h=function(){function o(){this.fetchOptions={headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:137.0) Gecko/20100101 Firefox/137.0",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8","Accept-Language":"en-US,us;q=0.5",Referer:"https://3b95ec29f71.2cabe16.xyz/",DNT:"1","Upgrade-Insecure-Requests":"1"}},this.id="bokuge",this.name="笔趣阁",this.icon="src/cn/mde2a0a8/icon.png",this.site="https://3b95ec29f71.2cabe16.xyz/",this.version="13.2.4"}return o.prototype.popularNovels=function(i){return t(this,void 0,void 0,(function(){var t,a,o,s=this;return e(this,(function(e){switch(e.label){case 0:return i>1?[2,[]]:[4,(0,n.fetchText)(this.site,this.fetchOptions)];case 1:if(""===(t=e.sent()))throw Error("无法获取小说列表，请检查网络");return a=(0,r.load)(t),o=[],a("div.wrap > div.hot > div.item").each((function(t,e){var r=a(e).find("div.p10 div.image a").attr("href"),n=a(e).find("div.p10 div.image a img").attr("src"),i=a(e).find("div.p10 div.image a img").attr("alt");r&&o.push({name:(null==i?void 0:i.trim())||"Untitled",cover:n,path:r.replace(s.site,"")})})),a("div.wrap > div.block ul.lis li").each((function(t,e){var r=a(e).find("span.s2 a").attr("href"),n=a(e).find("span.s2 a").text().trim();r&&o.push({name:n,cover:void 0,path:r.replace(s.site,"")})})),[2,o]}}))}))},o.prototype.parseNovel=function(o){return t(this,void 0,void 0,(function(){var t,s,c,h,p,f,d,v,m,b,g,w,x,y,k,U,_,C,q;return e(this,(function(e){switch(e.label){case 0:if(!(t=u(o,this.site)))throw new Error("Invalid novel URL");return[4,(0,n.fetchApi)(t)];case 1:if(!(s=e.sent()).ok)throw new Error("Failed to fetch novel");return h=r.load,[4,s.text()];case 2:switch(c=h.apply(void 0,[e.sent()]),p=c("div.books"),f=u(p.find("div.cover img").attr("src"),this.site)||a.defaultCover,d=p.find("div.book_box dl dt.name").text().trim(),v=p.find("div.book_box dl dd.dd_box span"),m=v.first().text().trim(),b=m.replace(/^.*?作者：/,"").trim()||void 0,g=v.eq(1).text().trim().replace(/^.*?分类：/,""),w=void 0,g){case"玄幻":w="Fantasy";break;case"武侠":w="Martial Arts";break;case"都市":w="Urban";break;case"历史":w="Historical";break;case"网游":w="Games";break;case"科幻":w="Sci-fi";break;case"女生":w="Girls";break;default:w=void 0}return x=v.eq(1).text().trim(),y="Unknown",y=x.includes("已经完本")?"Completed":x.includes("连载")?"Ongoing":"Unknown",(k=p.find("div.book_about dl dd").clone()).find("span.allshow").remove(),[4,l(k.text().trim(),"ru")];case 3:return U=e.sent(),_=p.find("div.book_more a").attr("href"),C={path:o,name:d||"Untitled",cover:f,summary:U||void 0,author:b,genres:w,status:"Ongoing"===y?i.NovelStatus.Ongoing:"Completed"===y?i.NovelStatus.Completed:i.NovelStatus.Unknown,chapters:[]},_?(q=C,[4,this.parseChapterList(_)]):[3,5];case 4:q.chapters=e.sent(),e.label=5;case 5:return[2,C]}}))}))},o.prototype.parseChapterList=function(i){return t(this,void 0,void 0,(function(){var t,a,o,s,c;return e(this,(function(e){switch(e.label){case 0:return(t=u(i,this.site))?[4,(0,n.fetchApi)(t)]:[2,[]];case 1:return(a=e.sent()).ok?(s=r.load,[4,a.text()]):[2,[]];case 2:return o=s.apply(void 0,[e.sent()]),c=[],o("div.book_last dl dd").each((function(t,e){var r,n=o(e).find("a");if("#footer"!==n.attr("href")){var i=null===(r=n.attr("href"))||void 0===r?void 0:r.trim(),a=n.text().trim();i&&a&&c.push({name:a,path:i,chapterNumber:c.length+1})}})),[2,c]}}))}))},o.prototype.parseChapter=function(i){return t(this,void 0,void 0,(function(){var t,a,o,s,c,u,h,p,f,d,v,m,b;return e(this,(function(e){switch(e.label){case 0:t=new URL(i,this.site).toString(),a=new URL(t).pathname.replace(/_\d+\.html$|\.html$/i,""),o=[],s=0,c=50,e.label=1;case 1:return t&&s<c?(s++,[4,(0,n.fetchText)(t,this.fetchOptions)]):[3,3];case 2:return u=e.sent(),h=(0,r.load)(u),(p=h("#chaptercontent").clone()).children("p").remove(),(f=null!==(b=null===(m=p.html())||void 0===m?void 0:m.trim())&&void 0!==b?b:"")&&(f=f.replace(/69书吧/g,"").replace(/请收藏：https?:\/\/m\.57ae58c447\.cfd/gi,"").replace(/内容未完，下一页继续阅读好紧/gi,""),o.push(f)),(d=h("#pb_next").attr("href"))?d.startsWith("#")||/^javascript:/i.test(d)||(v=new URL(d,t).toString())===t||new URL(v).pathname.replace(/_\d+\.html$|\.html$/i,"")!==a?[3,3]:(t=v,[3,1]):[3,3];case 3:return s>=c&&console.warn("parseChapter: reached max pages while following chapter parts"),[4,l(o.join("\n"),"ru")];case 4:return[2,e.sent()]}}))}))},o.prototype.searchNovels=function(r,n){return t(this,void 0,void 0,(function(){var t,i,a,o;return e(this,(function(e){switch(e.label){case 0:return n>1?[2,[]]:(t="".concat(this.site,"user/search.html?q=").concat(encodeURIComponent(r),"&so=on"),[4,fetch(t,{headers:{accept:"application/json",referer:"".concat(this.site,"s?q=").concat(encodeURIComponent(r)),"sec-ch-ua":'"Chromium";v="140", "Not=A?Brand";v="24", "Google Chrome";v="140"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"',"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36","x-requested-with":"XMLHttpRequest",dnt:"1"}})]);case 1:if(!(i=e.sent()).ok)throw new Error("Failed to fetch search results");return[4,i.text()];case 2:if("1"===(a=e.sent()).trim())throw new Error("No results");try{o=JSON.parse(a)}catch(t){return console.error("Failed to parse search results:",t),[2,[]]}return[2,o.map((function(t){return{path:t.url_list,cover:t.url_img,name:t.articlename,author:t.author,summary:t.intro}}))]}}))}))},o}();exports.default=new h;