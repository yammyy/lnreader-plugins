var t=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(a,i){function o(t){try{s(n.next(t))}catch(t){i(t)}}function c(t){try{s(n.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?a(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,c)}s((n=n.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,n,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=c(0),o.throw=c(1),o.return=c(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(c){return function(s){return function(c){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,c[0]&&(i=0)),i;)try{if(r=1,n&&(a=2&c[0]?n.return:c[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,c[1])).done)return a;switch(n=0,a&&(c=[2&c[0],a.value]),c[0]){case 0:case 1:a=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,n=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!a||c[1]>a[0]&&c[1]<a[3])){i.label=c[1];break}if(6===c[0]&&i.label<a[1]){i.label=a[1],a=c;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(c);break}a[2]&&i.ops.pop(),i.trys.pop();continue}c=e.call(t,i)}catch(t){c=[6,t],n=0}finally{r=a=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.makeChunksFromHTML=s,exports.translate=l,exports.translateAutoHotkeyStyle=p;var r=require("cheerio"),n=require("@libs/fetch"),a=require("@libs/defaultCover"),i=require("@libs/novelStatus"),o=function(){function o(){this.id="52shuku",this.name="52书库",this.site="https://www.52shuku.net/",this.version="4.4.5",this.icon="src/cn/52shuku/faviconV2.png",this.imageRequestInit={headers:{Referer:this.site}}}return o.prototype.popularNovels=function(i){return t(this,void 0,void 0,(function(){var t,o,c,s,u;return e(this,(function(e){switch(e.label){case 0:return i>1?[2,[]]:[4,(0,n.fetchApi)(this.site)];case 1:return(t=e.sent()).ok?(c=r.load,[4,t.text()]):[2,[]];case 2:return o=c.apply(void 0,[e.sent()]),s=[],u=new Set,o("div.relates").each((function(t,e){o(e).find("ul li").each((function(t,e){var r,n=o(e).find("a"),i=null===(r=n.attr("href"))||void 0===r?void 0:r.trim(),c=n.text().trim();i&&c&&!u.has(i)&&(s.push({name:c,path:i,cover:a.defaultCover}),u.add(i))}))})),[2,s]}}))}))},o.prototype.parseNovel=function(o){return t(this,void 0,void 0,(function(){var t,s,u,h,p,f,d,v,m,g,w,b;return e(this,(function(e){switch(e.label){case 0:if(!(t=c(o,this.site)))throw new Error("Invalid novel URL");return[4,(0,n.fetchApi)(t)];case 1:if(!(s=e.sent()).ok)throw new Error("Failed to fetch novel");return h=r.load,[4,s.text()];case 2:return u=h.apply(void 0,[e.sent()]),p=u("header.article-header h1").text().trim(),f="Unknown",p.includes("【完结")&&(f="Completed",p=(p=p.replace(/【完结】/,"").trim()).replace(/【完结+番外】/,"").trim()),p=p.replace(/【[^】]*】/g,"").trim(),d=p,p.includes("_")&&(m=p.split("_"),d=m.slice(0,-1).join("_").trim(),v=m[m.length-1].trim()),(g=u("article.article-content > p").not(".con_pc").map((function(t,e){return u(e).text().trim()})).get()[1])?[4,l(g,"ru")]:[3,4];case 3:w=(w=e.sent()).replace(/<[^>]+>/g,""),e.label=4;case 4:return b=[],u("article.article-content ul.list.clearfix li.mulu a").each((function(t,e){var r,n=u(e),a=(null!==(r=n.attr("href"))&&void 0!==r?r:"").trim(),i=n.text().trim();a&&i&&b.push({name:i,path:a,releaseTime:void 0})})),[2,{path:o,name:d,cover:a.defaultCover,summary:w,author:v,genres:void 0,status:"Completed"===f?i.NovelStatus.Completed:i.NovelStatus.Unknown,chapters:b}]}}))}))},o.prototype.parseChapter=function(a){return t(this,void 0,void 0,(function(){var t,i,o,s,u,l,p;return e(this,(function(e){switch(e.label){case 0:if(!(t=c(a,this.site)))throw new Error("Invalid chapter URL");return[4,(0,n.fetchApi)(t)];case 1:if(!(i=e.sent()).ok)throw new Error("Failed to fetch chapter");return s=r.load,[4,i.text()];case 2:return o=s.apply(void 0,[e.sent()]),(u=o("article.article-content div")).length?(u.find('script, style, iframe, button, hr, div, [class*="ads"], [id*="ads"], [class*="recommend"]').remove(),u.find("p").each((function(t,e){var r=o(e);(0===r.text().trim().length||r.find("span").length>0)&&r.remove()})),u.contents().filter((function(){return"comment"===this.type})).remove(),(l=u.html()||"")?(p="",l.trim()?[4,h(l,"ru")]:[3,4]):[2,"Error: Chapter content was empty"]):[2,"Error: Could not find chapter content"];case 3:return p=e.sent(),[3,5];case 4:p="",e.label=5;case 5:return[2,p.trim()]}}))}))},o.prototype.searchNovels=function(i,o){return t(this,void 0,void 0,(function(){var t,c,s,u,l;return e(this,(function(e){switch(e.label){case 0:return t="".concat(this.site,"so/search.php?q=").concat(encodeURIComponent(i),"&m=&f=_all&s=&p=").concat(o),[4,(0,n.fetchApi)(t)];case 1:return(c=e.sent()).ok?[4,c.text()]:[2,[]];case 2:return s=e.sent(),u=(0,r.load)(s),l=[],u("article.excerpt header h2 a").each((function(t,e){var r,n=u(e),i=null===(r=n.attr("href"))||void 0===r?void 0:r.trim(),o=n.text().trim();o=o.replace(/<[^>]+>/g,"").trim(),i&&o&&l.push({name:o,path:i,cover:a.defaultCover})})),[2,l]}}))}))},o}();exports.default=new o;var c=function(t,e){if(t)try{return t.startsWith("//")?new URL(e).protocol+t:t.startsWith("http://")||t.startsWith("https://")?t:new URL(t,e).href}catch(t){return}};function s(t,e){return void 0===e&&(e=1e3),function(t){return t.replace(/<\/p\s*>/gi,"\n").replace(/<p[^>]*>/gi,"\n").replace(/<br\s*\/?>/gi,"\n").replace(/<[^>]+>/g,"").replace(/\u3000/g," ").replace(/&nbsp;/g," ").trim().split(/\n+/).map((function(t){return t.trim()})).filter(Boolean)}(t).flatMap((function(t){return function(t,e){return void 0===e&&(e=1e3),t.length<=e?[t]:t.split(/([。.!?！？])/g).reduce((function(t,r){return!t.length||(t[t.length-1]+r).length>e?t.push(r):t[t.length-1]+=r,t}),[]).flatMap((function(t){if(t.length<=e)return[t];for(var r=[],n="",a=0,i=t.split(/\s+/);a<i.length;a++){var o=i[a];(n+" "+o).trim().length>e?(n&&r.push(n.trim()),n=o):n=(n+" "+o).trim()}return n&&r.push(n.trim()),r}))}(t,e)}))}function u(r,n){return t(this,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return[4,fetch("https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-CN&tl=".concat(n,"&dt=t&q=").concat(encodeURIComponent(r)))];case 1:if(!(t=e.sent()).ok)throw new Error("Translate failed ".concat(t.status," ").concat(r));return[4,t.json()];case 2:return[2,e.sent()[0].map((function(t){return t[0]})).join("")]}}))}))}function l(r,n){return t(this,void 0,void 0,(function(){var t,a,i,o,c,l,h;return e(this,(function(e){switch(e.label){case 0:if(r.length<2)return[2,r];t=s(r,1e3),a=[],i=0,o=t,e.label=1;case 1:return i<o.length?(c=o[i],h=(l=a).push,[4,u(c,n)]):[3,5];case 2:return h.apply(l,[e.sent()]),[4,new Promise((function(t){return setTimeout(t,500)}))];case 3:e.sent(),e.label=4;case 4:return i++,[3,1];case 5:return[2,a.map((function(t){return"<p>".concat(t,"</p>")})).join("\n")]}}))}))}function h(r,n){return t(this,void 0,void 0,(function(){var t,a,i,o,c,s,u,l,h,f,d,v;return e(this,(function(e){switch(e.label){case 0:for(r=r.replace(/<(\w+)[^>]*>/g,"<$1>"),t=[],a=new RegExp("(".concat(["</p>","</h1>","</h2>","</h3>","</h4>","</li>","<br>"].join("|"),")"),"gi"),i=r.split(a).filter(Boolean),f=0;f<i.length;f+=2)o=(i[f]||"").replace(/<[^>]+>/g,"").trim(),c=(i[f+1]||"").toLowerCase(),(o||c)&&("</li>"===c?o&&t.push({tag:"LI",text:o,parentTag:"UL"}):c.startsWith("</h")?(o&&t.push({tag:c.replace(/[<>]/g,"").toUpperCase(),text:o}),t.push({tag:"BR",text:""})):o&&t.push({tag:"P",text:o}));return s=" 😀 ",[4,p(t.map((function(t){return"BR"===t.tag?"":t.text})).join(s),n)];case 1:for(u=(u=e.sent()).replace(/^\[\[\"/,"").replace(/\"\],\s*\[\".*\"\]\]$/,""),l=u.split(s),h="",f=0;f<t.length;f++)d=t[f],v=l[f]||"",/^Глава\s+\d+/i.test(v)?h+="<h1>".concat(v,"</h1>"):"BR"===d.tag?h+="<br>":"LI"===d.tag?h+="<ul><li>".concat(v,"</li></ul>"):d.tag.startsWith("H")?h+="<".concat(d.tag,">").concat(v,"</").concat(d.tag,">"):h+="<p>".concat(v,"</p>");return[2,h]}}))}))}function p(r,n){return t(this,void 0,void 0,(function(){var t,a,i,o,c,s;return e(this,(function(e){switch(e.label){case 0:t="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36",a=JSON.stringify([[[r],"auto",n],"wt_lib"]),i="",e.label=1;case 1:return e.trys.push([1,6,,7]),[4,fetch("https://translate-pa.googleapis.com/v1/translateHtml",{method:"POST",headers:{"User-Agent":t,"X-Goog-API-Key":"AIzaSyATBXajvzQLTDHEQbcpq0Ihe0vWDHmO520","Content-Type":"application/json+protobuf"},body:a})];case 2:return(o=e.sent()).ok?[3,4]:(i="HTTP error ".concat(o.status,": ").concat(o.statusText),[4,o.text()]);case 3:return c=e.sent(),[2,i+="\nError body:"+c];case 4:return[4,o.text()];case 5:return i=e.sent(),[3,7];case 6:return s=e.sent(),i="Fetch failed:"+s,[3,7];case 7:return[2,i]}}))}))}