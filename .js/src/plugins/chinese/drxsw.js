var t=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(i,a){function o(t){try{s(n.next(t))}catch(t){a(t)}}function c(t){try{s(n.throw(t))}catch(t){a(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,c)}s((n=n.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,n,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=c(0),o.throw=c(1),o.return=c(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(c){return function(s){return function(c){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,c[0]&&(a=0)),a;)try{if(r=1,n&&(i=2&c[0]?n.return:c[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,c[1])).done)return i;switch(n=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,n=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){a.label=c[1];break}if(6===c[0]&&a.label<i[1]){a.label=i[1],i=c;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(c);break}i[2]&&a.ops.pop(),a.trys.pop();continue}c=e.call(t,a)}catch(t){c=[6,t],n=0}finally{r=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.makeChunksFromHTML=c,exports.translate=u;var r=require("cheerio"),n=require("@libs/fetch"),i=require("@libs/defaultCover"),a=require("@libs/novelStatus");function o(t,e){if(void 0===e&&(e=1e3),t.length<=e)return[t];var r=t.split(/([。.!?！？])/g).reduce((function(t,r){return 0===t.length?[r]:((t[t.length-1]+r).length>e?t.push(r):t[t.length-1]+=r,t)}),[]);return r=r.flatMap((function(t){if(t.length<=e)return[t];for(var r=[],n="",i=0,a=t.split(/\s+/);i<a.length;i++){var o=a[i];(n+" "+o).trim().length>e?(n&&r.push(n.trim()),n=o):n=(n+" "+o).trim()}return n&&r.push(n.trim()),r}))}function c(t,e){void 0===e&&(e=1e3);for(var r=function(t){return t.replace(/<\/p\s*>/gi,"\n").replace(/<p[^>]*>/gi,"\n").replace(/<br\s*\/?>/gi,"\n").replace(/<[^>]+>/g,"").replace(/\u3000/g," ").replace(/&nbsp;/g," ").trim().split(/\n+/).map((function(t){return t.trim()})).filter((function(t){return t.length>0}))}(t),n=[],i=0,a=r;i<a.length;i++){var c=o(a[i],e);n.push.apply(n,c)}return n}function s(r,n){return t(this,void 0,void 0,(function(){var t,i;return e(this,(function(e){switch(e.label){case 0:return t="https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-CN&tl=".concat(n,"&dt=t&q=").concat(encodeURIComponent(r)),[4,fetch(t)];case 1:if(!(i=e.sent()).ok)throw new Error("Translate request failed with status ".concat(i.status," ").concat(r));return[4,i.json()];case 2:return[2,e.sent()[0].map((function(t){return t[0]})).join("")]}}))}))}function u(r,n){return t(this,void 0,void 0,(function(){var t,i,a,o,u;return e(this,(function(e){switch(e.label){case 0:if(r.length<2)return[2,r];t=c(r,1e3),i=[],a=0,o=t,e.label=1;case 1:return a<o.length?[4,s(o[a],n)]:[3,5];case 2:return u=e.sent(),i.push(u),[4,new Promise((function(t){return setTimeout(t,500)}))];case 3:e.sent(),e.label=4;case 4:return a++,[3,1];case 5:return[2,i.map((function(t){return"<p>".concat(t,"</p>")})).join("\n")]}}))}))}var l=function(t,e){if(t)try{return t.startsWith("//")?new URL(e).protocol+t:t.startsWith("http://")||t.startsWith("https://")?t:new URL(t,e).href}catch(t){return}},d=function(){function o(){this.id="drxsw",this.name="冬日小说网",this.site="https://www.drxsw.com/",this.version="5.0.2",this.icon="src/cn/drxsw/logo.png",this.imageRequestInit={headers:{Referer:this.site}}}return o.prototype.popularNovels=function(a){return t(this,void 0,void 0,(function(){var t,o,c,s,u,d,h=this;return e(this,(function(e){switch(e.label){case 0:return a>1?[2,[]]:(t="".concat(this.site),[4,(0,n.fetchApi)(t)]);case 1:return(o=e.sent()).ok?(s=r.load,[4,o.text()]):[2,[]];case 2:return c=s.apply(void 0,[e.sent()]),u=[],d=new Set,c("div.recombook").find("dl").each((function(t,e){var r,n,a,o,s,f,p=c(e).find("dt a");o=null===(r=p.attr("href"))||void 0===r?void 0:r.trim(),f=null===(n=p.find("img").attr("data-src"))||void 0===n?void 0:n.trim(),s=null===(a=p.find("img").attr("alt"))||void 0===a?void 0:a.trim(),o&&s&&(u.push({name:s,path:o,cover:l(f,h.site)||i.defaultCover}),d.add(o))})),c("div.w_440").each((function(t,e){c(e).find("dl").each((function(t,e){var r,n,a,o,s,f,p=c(e).find("dt a");o=null===(r=p.attr("href"))||void 0===r?void 0:r.trim(),f=null===(n=p.find("img").attr("data-src"))||void 0===n?void 0:n.trim(),s=null===(a=p.find("img").attr("alt"))||void 0===a?void 0:a.trim(),o&&s&&(u.push({name:s,path:o,cover:l(f,h.site)||i.defaultCover}),d.add(o))}))})),[2,u]}}))}))},o.prototype.parseNovel=function(o){return t(this,void 0,void 0,(function(){var t,c,s,d,h,f,p,v,m,g,w,b,y,x,k,C;return e(this,(function(e){switch(e.label){case 0:if(!(t=l(o,this.site)))throw new Error("Invalid novel URL");return[4,(0,n.fetchApi)(t)];case 1:if(!(c=e.sent()).ok)throw new Error("Failed to fetch novel");return d=r.load,[4,c.text()];case 2:return s=d.apply(void 0,[e.sent()]),h=s("div#bookinfo"),f=h.find("div.bookright"),p=f.find("div#count ul li").first().find("span").text().trim(),v="Unknown",v="连载中"===p?"Completed":"已完结"===p?"Ongoing":"Unknown",m=f.find("#bookintro"),void 0===(g=null===(C=m.html())||void 0===C?void 0:C.replace(/<p[^>]*>/g,"\n").replace(/<\/p>/g,"").replace(/<[^>]+>/g,"").trim())?[3,4]:[4,u(g,"ru")];case 3:return w=(w=e.sent()).replace(/<[^>]+>/g,""),[3,5];case 4:w=void 0,e.label=5;case 5:switch(b=s("div.tabstit").contents().filter((function(t,e){return"text"===e.type})).map((function(t,e){return e.data.trim()})).get().filter((function(t){return t.length>0})),y=b[0]||""){case"玄幻小说":y="Fantasy";break;case"武俠小说":y="Martial Arts";break;case"都市小说":y="Urban";break;case"歷史小说":y="Historical";break;case"遊戲小说":y="Games";break;case"科幻小说":y="Sci-Fi";break;case"恐怖小说":y="Horror";break;case"其他小说":y="Other"}return x={path:o,name:f.find("div.d_title h1").text().trim(),cover:l(h.find("div.bookleft div#bookimg img").attr("src"),this.site)||i.defaultCover,summary:w,author:f.find("div.d_title .p_author").text().replace(/\uFEFF/g,"").replace(/\u00A0/g," ").replace(/^.*[:：]/,"").trim()||void 0,genres:y,status:"Ongoing"===v?a.NovelStatus.Ongoing:"Completed"===v?a.NovelStatus.Completed:a.NovelStatus.Unknown,chapters:[]},k=[],s("#chapterList").find("li a").each((function(t,e){var r,n=s(e),i=(null!==(r=n.attr("href"))&&void 0!==r?r:"").trim(),a=n.text().trim();k.push({name:a,path:i,releaseTime:void 0})})),x.chapters=k,[2,x]}}))}))},o.prototype.parseChapter=function(i){return t(this,void 0,void 0,(function(){var t,a,o,c,s,d,h,f;return e(this,(function(e){switch(e.label){case 0:if(!(t=l(i,this.site)))throw new Error("Invalid chapter URL");return[4,(0,n.fetchApi)(t)];case 1:if(!(a=e.sent()).ok)throw new Error("Failed to fetch chapter at ".concat(t));return[4,a.text()];case 2:return o=e.sent(),c=(0,r.load)(o),s=c("div.mlfy_main_text h1"),[4,u(d=s.text().trim(),"ru")];case 3:return d=e.sent(),(h=c("#TextContent")).length?(h.find("script, style, ins, iframe, .ads, .ad, .copy, .footer").remove(),(f=h.html())?[4,u(f=(0,r.load)("<div>".concat(f,"</div>")).text(),"ru")]:[2,"Error: Chapter content was empty"]):[2,"Error: Could not find chapter content at ".concat(t)];case 4:return f=e.sent(),[2,"<h1>".concat(d,"</h1> ").concat(f.trim())]}}))}))},o.prototype.searchNovels=function(a,o){return t(this,void 0,void 0,(function(){var t,c,s,u,d,h=this;return e(this,(function(e){switch(e.label){case 0:return o>1?[2,[]]:(t="".concat(this.site,"/s.php"),[4,(0,n.fetchApi)(t,{method:"POST",body:"searchkey=".concat(encodeURIComponent(a),"&searchtype=articlename"),headers:{"content-type":"application/x-www-form-urlencoded"}})]);case 1:if(403===(c=e.sent()).status)throw new Error("Captcha detected (HTTP 403), please open in webview.");return[4,c.text()];case 2:return s=e.sent(),u=(0,r.load)(s),d=[],u("dl#nr").each((function(t,e){var r,n,a,o=u(e),c=null===(r=o.find("dd h3 a").attr("href"))||void 0===r?void 0:r.trim(),s=o.find("dd h3 a").text().trim(),f=(null===(n=o.find("dt a img").attr("data-src"))||void 0===n?void 0:n.trim())||(null===(a=o.find("dt a img").attr("src"))||void 0===a?void 0:a.trim());c&&s&&d.push({name:s,path:c,cover:l(f,h.site)||i.defaultCover})})),[2,d]}}))}))},o}();exports.default=new d;