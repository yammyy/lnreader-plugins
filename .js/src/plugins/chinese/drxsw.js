var t=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(i,o){function a(t){try{s(n.next(t))}catch(t){o(t)}}function c(t){try{s(n.throw(t))}catch(t){o(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,c)}s((n=n.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,n,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=c(0),a.throw=c(1),a.return=c(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(c){return function(s){return function(c){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(o=0)),o;)try{if(r=1,n&&(i=2&c[0]?n.return:c[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,c[1])).done)return i;switch(n=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,n=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==c[0]&&2!==c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=e.call(t,o)}catch(t){c=[6,t],n=0}finally{r=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}};Object.defineProperty(exports,"__esModule",{value:!0});var r=require("cheerio"),n=require("@libs/fetch"),i=require("@libs/defaultCover"),o=require("@libs/novelStatus"),a=function(t,e){if(t)try{return t.startsWith("//")?new URL(e).protocol+t:t.startsWith("http://")||t.startsWith("https://")?t:new URL(t,e).href}catch(t){return}},c=function(){function c(){this.id="drxsw",this.name="冬日小说网",this.site="https://www.drxsw.com/",this.version="1.5.15",this.icon="src/cn/drxsw/logo.png",this.imageRequestInit={headers:{Referer:this.site}}}return c.prototype.popularNovels=function(o){return t(this,void 0,void 0,(function(){var t,c,s,l,d,u,h=this;return e(this,(function(e){switch(e.label){case 0:return o>1?[2,[]]:(t="".concat(this.site),[4,(0,n.fetchApi)(t)]);case 1:return(c=e.sent()).ok?(l=r.load,[4,c.text()]):[2,[]];case 2:return s=l.apply(void 0,[e.sent()]),d=[],u=new Set,s("div.recombook").find("dl").each((function(t,e){var r,n,o,c,l,f,p=s(e).find("dt a");c=null===(r=p.attr("href"))||void 0===r?void 0:r.trim(),f=null===(n=p.find("img").attr("data-src"))||void 0===n?void 0:n.trim(),l=null===(o=p.find("img").attr("alt"))||void 0===o?void 0:o.trim(),c&&l&&(d.push({name:l,path:c,cover:a(f,h.site)||i.defaultCover}),u.add(c))})),s("div.w_440").each((function(t,e){s(e).find("dl").each((function(t,e){var r,n,o,c,l,f,p=s(e).find("dt a");c=null===(r=p.attr("href"))||void 0===r?void 0:r.trim(),f=null===(n=p.find("img").attr("data-src"))||void 0===n?void 0:n.trim(),l=null===(o=p.find("img").attr("alt"))||void 0===o?void 0:o.trim(),c&&l&&(d.push({name:l,path:c,cover:a(f,h.site)||i.defaultCover}),u.add(c))}))})),[2,d]}}))}))},c.prototype.parseNovel=function(c){return t(this,void 0,void 0,(function(){var t,s,l,d,u,h,f,p,v,m,w,b,y,g,x,k;return e(this,(function(e){switch(e.label){case 0:if(!(t=a(c,this.site)))throw new Error("Invalid novel URL");return[4,(0,n.fetchApi)(t)];case 1:if(!(s=e.sent()).ok)throw new Error("Failed to fetch novel");return d=r.load,[4,s.text()];case 2:return l=d.apply(void 0,[e.sent()]),u=l("div#bookinfo"),h=u.find("div.bookright"),f=h.find("div#count ul li").first().find("span").text().trim(),p="Unknown",p="连载中"===f?"Completed":"已完结"===f?"Ongoing":"Unknown",v=h.find("#bookintro"),m=null===(k=v.html())||void 0===k?void 0:k.replace(/<p[^>]*>/g,"\n").replace(/<\/p>/g,"").replace(/<[^>]+>/g,"").trim(),w=l("div.tabstit").html()||"",b=w.match(/＞([^＞<]*?小说)/),y=null==b?void 0:b[1].trim(),g={path:c,name:h.find("div.d_title h1").text().trim(),cover:a(u.find("div.bookleft div#bookimg img").attr("src"),this.site)||i.defaultCover,summary:m,author:h.find("div.d_title .p_author").text().replace(/\uFEFF/g,"").replace(/\u00A0/g," ").replace(/^.*[:：]/,"").trim()||void 0,genres:y,status:"Ongoing"===p?o.NovelStatus.Ongoing:"Completed"===p?o.NovelStatus.Completed:o.NovelStatus.Unknown,chapters:[]},x=[],l("#chapterList").find("li a").each((function(t,e){var r,n=l(e),i=(null!==(r=n.attr("href"))&&void 0!==r?r:"").trim(),o=n.text().trim();x.push({name:o,path:i,releaseTime:void 0})})),g.chapters=x,[2,g]}}))}))},c.prototype.parseChapter=function(i){return t(this,void 0,void 0,(function(){var t,o,c,s,l,d;return e(this,(function(e){switch(e.label){case 0:if(!(t=a(i,this.site)))throw new Error("Invalid chapter URL");return[4,(0,n.fetchApi)(t)];case 1:if(!(o=e.sent()).ok)throw new Error("Failed to fetch chapter at ".concat(t));return[4,o.text()];case 2:return c=e.sent(),s=(0,r.load)(c),(l=s("#TextContent")).length?(l.find("script, style, ins, iframe, .ads, .ad, .copy, .footer").remove(),[2,(null===(d=l.html())||void 0===d?void 0:d.trim())||""]):[2,"Error: Could not find chapter content at ".concat(t)]}}))}))},c.prototype.searchNovels=function(o,c){return t(this,void 0,void 0,(function(){var t,s,l,d,u,h=this;return e(this,(function(e){switch(e.label){case 0:return c>1?[2,[]]:(t="".concat(this.site,"/s.php"),[4,(0,n.fetchApi)(t,{method:"POST",body:"searchkey=".concat(encodeURIComponent(o),"&searchtype=articlename"),headers:{"content-type":"application/x-www-form-urlencoded"}})]);case 1:if(403===(s=e.sent()).status)throw new Error("Captcha detected (HTTP 403), please open in webview.");return[4,s.text()];case 2:return l=e.sent(),d=(0,r.load)(l),u=[],d("dl#nr").each((function(t,e){var r,n,o,c=d(e),s=null===(r=c.find("dd h3 a").attr("href"))||void 0===r?void 0:r.trim(),l=c.find("dd h3 a").text().trim(),f=(null===(n=c.find("dt a img").attr("data-src"))||void 0===n?void 0:n.trim())||(null===(o=c.find("dt a img").attr("src"))||void 0===o?void 0:o.trim());s&&l&&u.push({name:l,path:s,cover:a(f,h.site)||i.defaultCover})})),[2,u]}}))}))},c}();exports.default=new c;