var t=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(i,a){function o(t){try{c(n.next(t))}catch(t){a(t)}}function s(t){try{c(n.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,s)}c((n=n.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,n,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(c){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.makeChunksFromHTML=l,exports.translate=h,exports.translateAutoHotkeyStyle=f;var r=require("cheerio"),n=require("@libs/fetch"),i=require("@libs/novelStatus"),a=require("@libs/defaultCover"),o=require("@libs/storage"),s=function(){function s(){this.fetchOptions={headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","Accept-Language":"ru,en-US;q=0.9,en;q=0.8,zh-TW;q=0.7,zh-CN;q=0.6,zh;q=0.5",Referer:"https://87bd21b0b1f922b7160.5df7ec.cfd//",DNT:"1","Upgrade-Insecure-Requests":"1"}},this.id="bikuge",this.name="Á¨îË∂£ÈòÅ (ab9a1c1018b5.5df7ec.cfd)",this.icon="src/cn/mde2a0a8/icon.png",this.site="https://93f8512c890cd16909.4c7f720b2.lol/",this.version="28.2.5",this.siteName=o.storage.get("siteName"),this.pluginSettings={siteName:{value:"",label:"Site name",type:"TextInput"}}}return s.prototype.popularNovels=function(i){return t(this,void 0,void 0,(function(){var t,a,o,s,c=this;return e(this,(function(e){switch(e.label){case 0:return i>1?[2,[]]:(t=this.site,""!==this.siteName.trim()&&(t=this.siteName),[4,(0,n.fetchText)(t,this.fetchOptions)]);case 1:if(""===(a=e.sent()))throw Error("Êó†Ê≥ïËé∑ÂèñÂ∞èËØ¥ÂàóË°®ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú");return o=(0,r.load)(a),s=[],o("div.wrap > div.hot > div.item").each((function(t,e){var r=o(e).find("div.p10 div.image a").attr("href"),n=o(e).find("div.p10 div.image a img").attr("src"),i=o(e).find("div.p10 div.image a img").attr("alt");r&&s.push({name:(null==i?void 0:i.trim())||"Untitled",cover:n,path:r.replace(c.site,"")})})),o("div.wrap > div.block ul.lis li").each((function(e,r){var n=o(r).find("span.s2 a").attr("href"),i=o(r).find("span.s2 a").text().trim();n&&s.push({name:i,cover:void 0,path:n.replace(t,"")})})),[2,s]}}))}))},s.prototype.parseNovel=function(o){return t(this,void 0,void 0,(function(){var t,s,l,u,p,f,d,m,v,g,b,w,x,y,k,N,C,T,L,q;return e(this,(function(e){switch(e.label){case 0:if(t=this.site,""!==this.siteName.trim()&&(t=this.siteName),!(s=c(o,t)))throw new Error("Invalid novel URL");return[4,(0,n.fetchApi)(s)];case 1:if(!(l=e.sent()).ok)throw new Error("Failed to fetch novel");return p=r.load,[4,l.text()];case 2:switch(u=p.apply(void 0,[e.sent()]),f=u("div.books"),d=c(f.find("div.cover img").attr("src"),this.site)||a.defaultCover,m=f.find("div.book_box dl dt.name").text().trim(),v=f.find("div.book_box dl dd.dd_box span"),g=v.first().text().trim(),b=g.replace(/^.*?‰ΩúËÄÖÔºö/,"").trim()||void 0,w=v.eq(1).text().trim().replace(/^.*?ÂàÜÁ±ªÔºö/,""),x=void 0,w){case"ÁéÑÂπª":x="Fantasy";break;case"Ê≠¶‰æ†":x="Martial Arts";break;case"ÈÉΩÂ∏Ç":x="Urban";break;case"ÂéÜÂè≤":x="Historical";break;case"ÁΩëÊ∏∏":x="Games";break;case"ÁßëÂπª":x="Sci-fi";break;default:x=void 0}return y=v.eq(1).text().trim(),k="Unknown",k=y.includes("Â∑≤ÁªèÂÆåÊú¨")?"Completed":y.includes("ËøûËΩΩ")?"Ongoing":"Unknown",(N=f.find("div.book_about dl dd").clone()).find("span.allshow").remove(),[4,h(N.text().trim(),"ru")];case 3:return C=e.sent(),T=f.find("div.book_more a").attr("href"),L={path:o,name:m||"Untitled",cover:d,summary:C||void 0,author:b,genres:x,status:"Ongoing"===k?i.NovelStatus.Ongoing:"Completed"===k?i.NovelStatus.Completed:i.NovelStatus.Unknown,chapters:[]},T?(q=L,[4,this.parseChapterList(T)]):[3,5];case 4:q.chapters=e.sent(),e.label=5;case 5:return[2,L]}}))}))},s.prototype.parseChapterList=function(i){return t(this,void 0,void 0,(function(){var t,a,o,s,l,u;return e(this,(function(e){switch(e.label){case 0:return t=this.site,""!==this.siteName.trim()&&(t=this.siteName),(a=c(i,t))?[4,(0,n.fetchApi)(a)]:[2,[]];case 1:return(o=e.sent()).ok?(l=r.load,[4,o.text()]):[2,[]];case 2:return s=l.apply(void 0,[e.sent()]),u=[],s("div.book_last dl dd").each((function(t,e){var r,n=s(e).find("a");if("#footer"!==n.attr("href")){var i=null===(r=n.attr("href"))||void 0===r?void 0:r.trim(),a=n.text().trim();i&&a&&u.push({name:a,path:i,chapterNumber:u.length+1})}})),[2,u]}}))}))},s.prototype.parseChapter=function(i){return t(this,void 0,void 0,(function(){var t,a,o,s,c,l,u,h,f,d,m,v,g,b,w;return e(this,(function(e){switch(e.label){case 0:t=this.site,""!==this.siteName.trim()&&(t=this.siteName),a=new URL(i,t).toString(),o=new URL(a).pathname.replace(/_\d+\.html$|\.html$/i,""),s=[],c=0,l=50,e.label=1;case 1:return a&&c<l?(c++,[4,(0,n.fetchText)(a,this.fetchOptions)]):[3,3];case 2:return u=e.sent(),h=(0,r.load)(u),(f=h("#chaptercontent").clone()).children("p").remove(),d=null!==(w=null===(b=f.html())||void 0===b?void 0:b.trim())&&void 0!==w?w:"",console.log(d),d&&(d=d.replace(/ËØ∑Êî∂ËóèÔºöhttps?:\/\//gi,"").replace(/ÂÜÖÂÆπÊú™ÂÆåÔºå‰∏ã‰∏ÄÈ°µÁªßÁª≠ÈòÖËØªÂ•ΩÁ¥ß/gi,""),s.push(d)),(m=h("#pb_next").attr("href"))?m.startsWith("#")||/^javascript:/i.test(m)||(v=new URL(m,a).toString())===a||new URL(v).pathname.replace(/_\d+\.html$|\.html$/i,"")!==o?[3,3]:(a=v,[3,1]):[3,3];case 3:return c>=l&&console.warn("parseChapter: reached max pages while following chapter parts"),g=s.join("<br>"),console.log("Full chapter HTML before translation:",g),[4,p(g,"ru")];case 4:return[2,e.sent()]}}))}))},s.prototype.searchNovels=function(r,n){return t(this,void 0,void 0,(function(){var t,i,a,o,s;return e(this,(function(e){switch(e.label){case 0:return n>1?[2,[]]:(t=this.site,""!==this.siteName.trim()&&(t=this.siteName),i="".concat(t,"user/search.html?q=").concat(encodeURIComponent(r),"&so=undefined"),[4,fetch(i,{headers:{accept:"application/json",referer:"".concat(t,"s?q=").concat(encodeURIComponent(r)),"sec-ch-ua":'"Google Chrome";v="141", "Not?A_Brand";v="8", "Chromium";v="141"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"',"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36","x-requested-with":"XMLHttpRequest",dnt:"1"}})]);case 1:if(!(a=e.sent()).ok)throw new Error("Failed to fetch search results");return[4,a.text()];case 2:if("1"===(o=e.sent()).trim())throw new Error("No results");console.log("Search response text:",o);try{"string"==typeof(s=JSON.parse(o))&&(s=JSON.parse(s))}catch(t){return console.error("Failed to parse search results:",t),[2,[]]}return[2,s.map((function(t){return{path:t.url_list,cover:t.url_img,name:t.articlename,author:t.author,summary:t.intro}}))]}}))}))},s}();exports.default=new s;var c=function(t,e){if(t)try{if(t.startsWith("//"))return new URL(e).protocol+t;if(t.startsWith("http://")||t.startsWith("https://"))return t;var r=e.endsWith("/")?e.slice(0,-1):e,n=t.startsWith("/")?t.slice(1):t;return new URL(n,r).href}catch(t){return}};function l(t,e){return void 0===e&&(e=1e3),function(t){return t.replace(/<\/p\s*>/gi,"\n").replace(/<p[^>]*>/gi,"\n").replace(/<br\s*\/?>/gi,"\n").replace(/<[^>]+>/g,"").replace(/\u3000/g," ").replace(/&nbsp;/g," ").trim().split(/\n+/).map((function(t){return t.trim()})).filter(Boolean)}(t).flatMap((function(t){return function(t,e){return void 0===e&&(e=1e3),t.length<=e?[t]:t.split(/([„ÄÇ.!?ÔºÅÔºü])/g).reduce((function(t,r){return!t.length||(t[t.length-1]+r).length>e?t.push(r):t[t.length-1]+=r,t}),[]).flatMap((function(t){if(t.length<=e)return[t];for(var r=[],n="",i=0,a=t.split(/\s+/);i<a.length;i++){var o=a[i];(n+" "+o).trim().length>e?(n&&r.push(n.trim()),n=o):n=(n+" "+o).trim()}return n&&r.push(n.trim()),r}))}(t,e)}))}function u(r,n){return t(this,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return[4,fetch("https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-CN&tl=".concat(n,"&dt=t&q=").concat(encodeURIComponent(r)))];case 1:if(!(t=e.sent()).ok)throw new Error("Translate failed ".concat(t.status," ").concat(r));return[4,t.json()];case 2:return[2,e.sent()[0].map((function(t){return t[0]})).join("")]}}))}))}function h(r,n){return t(this,void 0,void 0,(function(){var t,i,a,o,s,c,h;return e(this,(function(e){switch(e.label){case 0:if(r.length<2)return[2,r];t=l(r,1e3),i=[],a=0,o=t,e.label=1;case 1:return a<o.length?(s=o[a],h=(c=i).push,[4,u(s,n)]):[3,5];case 2:return h.apply(c,[e.sent()]),[4,new Promise((function(t){return setTimeout(t,500)}))];case 3:e.sent(),e.label=4;case 4:return a++,[3,1];case 5:return[2,i.map((function(t){return"<p>".concat(t,"</p>")})).join("\n")]}}))}))}function p(r,n){return t(this,arguments,void 0,(function(t,r,n){var i,a,o,s,c,l,u,h,p,d,m,v,g,b;return void 0===n&&(n="auto"),e(this,(function(e){switch(e.label){case 0:for(t=t.replace(/<(\w+)[^>]*>/g,"<$1>"),i=["</p>","</h1>","</h2>","</h3>","</h4>","</li>","<br>"],a=[],o=new RegExp("(".concat(i.join("|"),")"),"gi"),s=t.split(o).filter(Boolean),v=0;v<s.length;v++)c=s[v],i.includes(c.toLowerCase())||(l=s[v+1]&&i.includes(s[v+1].toLowerCase())?s[v+1].toLowerCase():"",(u=c.replace(/<[^>]+>/g,"").trim())&&("</li>"===l?a.push({tag:"LI",text:u,parentTag:"UL"}):l.startsWith("</h")?(a.push({tag:l.replace(/[<>]/g,"").toUpperCase(),text:u}),a.push({tag:"BR",text:""})):a.push({tag:"P",text:u})));return h=" üòÄ ",[4,f(a.map((function(t){return"BR"===t.tag?"":t.text})).join(h),r,n)];case 1:for(p=(p=e.sent()).replace(/^\[\[\"/,"").replace(/\"\],\s*\[\".*\"\]\]$/,""),d=p.split(h),m="",v=0;v<a.length;v++)g=a[v],b=d[v]||"",/^–ì–ª–∞–≤–∞\s+\d+/i.test(b)?m+="<h1>".concat(b,"</h1>"):"BR"===g.tag?m+="<br>":"LI"===g.tag?m+="<ul><li>".concat(b,"</li></ul>"):g.tag.startsWith("H")?m+="<".concat(g.tag,">").concat(b,"</").concat(g.tag,">"):m+="<p>".concat(b,"</p>");return[2,m]}}))}))}function f(r,n){return t(this,arguments,void 0,(function(t,r,n){var i,a,o,s,c,l;return void 0===n&&(n="auto"),e(this,(function(e){switch(e.label){case 0:i="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36",a=JSON.stringify([[[t],n,r],"te_lib"]),o="",e.label=1;case 1:return e.trys.push([1,6,,7]),[4,fetch("https://translate-pa.googleapis.com/v1/translateHtml",{method:"POST",headers:{"User-Agent":i,"X-Goog-API-Key":"AIzaSyATBXajvzQLTDHEQbcpq0Ihe0vWDHmO520","Content-Type":"application/json+protobuf"},body:a})];case 2:return(s=e.sent()).ok?[3,4]:(o="HTTP error ".concat(s.status,": ").concat(s.statusText),[4,s.text()]);case 3:return c=e.sent(),[2,o+="\nError body:"+c];case 4:return[4,s.text()];case 5:return o=e.sent(),[3,7];case 6:return l=e.sent(),o="Fetch failed:"+l,[3,7];case 7:return[2,o]}}))}))}