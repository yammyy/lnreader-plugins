var t=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,o){function a(t){try{c(r.next(t))}catch(t){o(t)}}function s(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}c((r=r.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.makeChunksFromHTML=s,exports.translate=l;var n=require("cheerio"),r=require("@libs/fetch"),i=require("@libs/defaultCover"),o=require("@libs/novelStatus");function a(t,e){if(void 0===e&&(e=1e3),t.length<=e)return[t];var n=t.split(/([。.!?！？])/g).reduce((function(t,n){return 0===t.length?[n]:((t[t.length-1]+n).length>e?t.push(n):t[t.length-1]+=n,t)}),[]);return n=n.flatMap((function(t){if(t.length<=e)return[t];for(var n=[],r="",i=0,o=t.split(/\s+/);i<o.length;i++){var a=o[i];(r+" "+a).trim().length>e?(r&&n.push(r.trim()),r=a):r=(r+" "+a).trim()}return r&&n.push(r.trim()),n}))}function s(t,e){void 0===e&&(e=1e3);for(var n=function(t){return t.replace(/<\/p\s*>/gi,"\n").replace(/<p[^>]*>/gi,"\n").replace(/<br\s*\/?>/gi,"\n").replace(/<[^>]+>/g,"").replace(/\u3000/g," ").replace(/&nbsp;/g," ").trim().split(/\n+/).map((function(t){return t.trim()})).filter((function(t){return t.length>0}))}(t),r=[],i=0,o=n;i<o.length;i++){var s=a(o[i],e);r.push.apply(r,s)}return r}function c(n,r){return t(this,void 0,void 0,(function(){var t,i;return e(this,(function(e){switch(e.label){case 0:return t="https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-CN&tl=".concat(r,"&dt=t&q=").concat(encodeURIComponent(n)),[4,fetch(t)];case 1:if(!(i=e.sent()).ok)throw new Error("Translate request failed with status ".concat(i.status," ").concat(n));return[4,i.json()];case 2:return[2,e.sent()[0].map((function(t){return t[0]})).join("")]}}))}))}function l(n,r){return t(this,void 0,void 0,(function(){var t,i,o,a,l;return e(this,(function(e){switch(e.label){case 0:if(n.length<2)return[2,n];t=s(n,1e3),i=[],o=0,a=t,e.label=1;case 1:return o<a.length?[4,c(a[o],r)]:[3,5];case 2:return l=e.sent(),i.push(l),[4,new Promise((function(t){return setTimeout(t,500)}))];case 3:e.sent(),e.label=4;case 4:return o++,[3,1];case 5:return[2,i.map((function(t){return"<p>".concat(t,"</p>")})).join("\n")]}}))}))}var u=function(t,e){if(t)try{return t.startsWith("//")?new URL(e).protocol+t:t.startsWith("http://")||t.startsWith("https://")?t:new URL(t,e).href}catch(t){return}},h=function(){function a(){this.id="ixdzs8",this.name="爱下电子书",this.site="https://ixdzs8.com/",this.version="5.0.1",this.icon="src/cn/ixdzs8/favicon.png",this.imageRequestInit={headers:{Referer:this.site}}}return a.prototype.popularNovels=function(o){return t(this,void 0,void 0,(function(){var t,a,s,c,l,h,f=this;return e(this,(function(e){switch(e.label){case 0:return t="".concat(this.site,"hot/?page=").concat(o),[4,(0,r.fetchApi)(t)];case 1:return(a=e.sent()).ok?(c=n.load,[4,a.text()]):[2,[]];case 2:return s=c.apply(void 0,[e.sent()]),l=[],h=new Set,s("ul.u-list > li.burl").each((function(t,e){var n,r,o,a,c,p=s(e),d=p.find(".l-info h3 a");o=null===(n=d.attr("href"))||void 0===n?void 0:n.trim(),a=(d.attr("title")||d.text()||"").trim(),c=null===(r=p.find(".l-img img").attr("src"))||void 0===r?void 0:r.trim(),o&&a&&(l.push({name:a,path:o,cover:u(c,f.site)||i.defaultCover}),h.add(o))})),[2,l]}}))}))},a.prototype.parseNovel=function(a){return t(this,void 0,void 0,(function(){var t,s,c,h,f,p,d,v,m,g,w,b,y,x,C,k;return e(this,(function(e){switch(e.label){case 0:if(!(t=u(a,this.site)))throw new Error("Invalid novel URL");return[4,(0,r.fetchApi)(t)];case 1:if(!(s=e.sent()).ok)throw new Error("Failed to fetch novel");return h=n.load,[4,s.text()];case 2:return c=h.apply(void 0,[e.sent()]),f=c("div.novel"),(p=c("p#intro.pintro")).find("span.icon").remove(),void 0===(d=null===(k=p.html())||void 0===k?void 0:k.replace(/<br\s*\/?>/gi,"\n").replace(/<[^>]+>/g,"").replace(/\u3000/g," ").replace(/&nbsp;/g," ").split("\n").map((function(t){return t.trim()})).filter((function(t){return t.length>0})).join(" "))?[3,4]:[4,l(d,"ru")];case 3:return v=e.sent(),[3,5];case 4:v=void 0,e.label=5;case 5:return m=c("div.panel div.tags"),g=f.find(".n-text p span.lz").text().trim(),w=f.find(".n-text p span.end").text().trim(),b="Unknown",b=w.length>0?"Completed":g.length>0?"Ongoing":"Unknown",y={path:a,name:f.find(".n-text h1").text().trim()||"Untitled",cover:u(f.find(".n-img img").attr("src"),this.site)||i.defaultCover,summary:v,author:f.find(".n-text p a.bauthor").text().trim()||void 0,genres:m.find("em a").map((function(t,e){return c(e).text().trim()})).get().filter((function(t){return t.length>0})).join(", "),status:"Ongoing"===b?o.NovelStatus.Ongoing:"Completed"===b?o.NovelStatus.Completed:o.NovelStatus.Unknown,chapters:[]},(x=c("#bid").attr("value"))?(C=y,[4,this.parseChapterList(x)]):[3,7];case 6:C.chapters=e.sent(),e.label=7;case 7:return[2,y]}}))}))},a.prototype.parseChapterList=function(n){return t(this,void 0,void 0,(function(){var t,r,i,o;return e(this,(function(e){switch(e.label){case 0:return t=String(n),r="".concat(this.site,"novel/clist/"),[4,fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"bid=".concat(t)})];case 1:if(!(i=e.sent()).ok)throw new Error("Failed to fetch chapters for bid=".concat(t));return[4,i.json()];case 2:if(200!==(o=e.sent()).rs||!Array.isArray(o.data))throw new Error("Invalid response format from chapter list");return[2,o.data.map((function(e){return{name:e.title,path:"0"===e.ctype?"read/".concat(t,"/p").concat(e.ordernum,".html"):"",releaseTime:void 0}}))]}}))}))},a.prototype.parseChapter=function(i){return t(this,void 0,void 0,(function(){var t,o,a,s,c,h,f,p,d,v;return e(this,(function(e){switch(e.label){case 0:if(!(t=u(i,this.site)))throw new Error("Invalid chapter URL");return[4,(0,r.fetchApi)(t)];case 1:if(!(o=e.sent()).ok)throw new Error("Failed to fetch chapter at ".concat(t));return[4,o.text()];case 2:return((a=e.sent()).includes("正在進行安全驗證")||a.includes("challenge"))&&(s=a.match(/let token\s*=\s*"([^"]+)"/))?(c=t+"?challenge="+encodeURIComponent(s[1]),[4,(0,r.fetchApi)(c)]):[3,5];case 3:if(!(o=e.sent()).ok)throw new Error("Failed after challenge redirect: ".concat(c));return[4,o.text()];case 4:a=e.sent(),e.label=5;case 5:return h=(0,n.load)(a),f=h("article h3"),[4,l(p=f.text().trim(),"ru")];case 6:return p=e.sent(),(d=h("article section")).length?(d.find('script, style, ins, iframe, [class*="abg"], [class*="ads"], [id*="ads"], [class*="google"], [id*="google"], [class*="recommend"], div[align="center"], p:contains("推薦本書"), a[href*="javascript:"]').remove(),d.find("p").each((function(t,e){var n=h(e);n.text().trim()||n.remove()})),d.contents().filter((function(){return"comment"===this.type})).remove(),(v=d.html())?[4,l(v=(0,n.load)("<div>".concat(v,"</div>")).text(),"ru")]:[2,"Error: Chapter content was empty"]):[2,"Error: Could not find chapter content at ".concat(t)];case 7:return v=e.sent(),[2,"<h1>".concat(p,"</h1> ").concat(v.trim())]}}))}))},a.prototype.searchNovels=function(o,a){return t(this,void 0,void 0,(function(){var t,a,s,c,l,h,f=this;return e(this,(function(e){switch(e.label){case 0:t="".concat(this.site,"bsearch?q=").concat(encodeURIComponent(o)),a="",e.label=1;case 1:return e.trys.push([1,4,,5]),[4,(0,r.fetchApi)(t)];case 2:if(!(s=e.sent()).ok)throw new Error("Failed to fetch search results: HTTP ".concat(s.status));return[4,s.text()];case 3:return a=e.sent(),[3,5];case 4:if((c=e.sent())instanceof Error)throw new Error("Failed to fetch search results: ".concat(c.message));throw c;case 5:return l=(0,n.load)(a),h=[],l("ul.u-list li.burl").each((function(t,e){var n,r,o=l(e),a=null===(n=o.attr("data-url"))||void 0===n?void 0:n.trim(),s=o.find("h3.bname a").text().trim(),c=null===(r=o.find(".l-img img").attr("src"))||void 0===r?void 0:r.trim();a&&s&&h.push({name:s,path:a,cover:u(c,f.site)||i.defaultCover})})),[2,h]}}))}))},a}();exports.default=new h;